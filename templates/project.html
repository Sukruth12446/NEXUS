{% extends "base.html" %}
{% block content %}
<h2>{{ project.title }}</h2>

<section class="pane">
  <h3>Upload interview / audio</h3>
  <form action="{{ url_for('upload_file', project_id=project.id) }}" method="post" enctype="multipart/form-data">
    <input type="file" name="file" accept=".mp3,.wav,.m4a,.mp4,.mov" required />
    <button type="submit">Upload & Transcribe</button>
  </form>
  <h4>Transcripts</h4>
  <ul>
    {% for t in transcripts %}
      <li>
        <a href="{{ url_for('download_file', filename=t.filename) }}">{{ t.filename }}</a>
        <div class="transcript-box">{{ t.text[:800] }}{% if t.text|length > 800 %}...{% endif %}</div>
      </li>
    {% else %}
      <li>No transcripts yet</li>
    {% endfor %}
  </ul>
</section>

<section class="pane">
  <h3>Script editor</h3>
  <form method="post" action="{{ url_for('save_script', project_id=project.id) }}">
    <textarea name="content" rows="12" placeholder="Write your script here..."></textarea>
    <div style="margin-top:8px">
      <button type="submit">Save script</button>
      <button type="button" id="suggest-btn">AI Suggest Improvement</button>
    </div>
  </form>
  <h4>Saved Scripts</h4>
  <ul>
    {% for s in scripts %}
      <li><pre>{{ s.content[:500] }}{% if s.content|length>500 %}...{% endif %}</pre></li>
    {% else %}
      <li>No scripts yet</li>
    {% endfor %}
  </ul>
</section>

<section class="pane">
  <h3>Storyboard</h3>
  <form method="post" action="{{ url_for('add_card', project_id=project.id) }}">
    <input type="text" name="title" placeholder="Card title" required />
    <input type="text" name="notes" placeholder="Short notes" />
    <button type="submit">Add Card</button>
  </form>
  <div id="storyboard">
    {% for c in cards %}
      <div class="card" data-id="{{ c.id }}">
        <h4 contenteditable="true">{{ c.title }}</h4>
        <div contenteditable="true">{{ c.notes }}</div>
      </div>
    {% else %}
      <p>No storyboard cards yet</p>
    {% endfor %}
  </div>
  <button id="save-order">Save storyboard order</button>
</section>

<section class="pane">
  <h3>Comments & Tasks</h3>
  <form method="post" action="{{ url_for('add_comment', project_id=project.id) }}">
    <input type="text" name="author" placeholder="Your name" />
    <input type="text" name="content" placeholder="Comment or task" required />
    <button type="submit">Add</button>
  </form>
  <ul>
    {% for c in comments %}
      <li><strong>{{ c.author }}</strong> ({{ c.created_at.strftime('%Y-%m-%d %H:%M') }}): {{ c.content }}</li>
    {% else %}
      <li>No comments yet</li>
    {% endfor %}
  </ul>
</section>

<script>
$(function(){
  $("#suggest-btn").click(function(){
    const txt = $("textarea[name='content']").val();
    if(!txt) return alert("Write something first");
    $(this).prop("disabled", true).text("Thinking...");
    fetch("{{ url_for('script_suggest') }}", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({content: txt})
    }).then(r=>r.json()).then(data=>{
      $("textarea[name='content']").val(data.suggestion);
    }).catch(e=>alert("Suggestion failed")).finally(()=>$("#suggest-btn").prop("disabled",false).text("AI Suggest Improvement"));
  });

  // Simple drag reorder (client side)
  $("#storyboard").on("dragstart", ".card", function(e){
    e.originalEvent.dataTransfer.setData("text/plain", $(this).data("id"));
  });

  // Allow dropping container
  $("#storyboard").on("dragover", function(e){ e.preventDefault(); });

  $("#storyboard").on("drop", function(e){
    e.preventDefault();
    const id = e.originalEvent.dataTransfer.getData("text/plain");
    const card = $(`[data-id='${id}']`);
    $(this).append(card);
  });

  $("#save-order").click(function(){
    const order = $("#storyboard .card").map(function(){ return $(this).data("id"); }).get();
    fetch("{{ url_for('update_order', project_id=project.id) }}", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({order})
    }).then(()=>alert("Order saved"));
  });

  // make cards draggable
  $("#storyboard .card").attr("draggable", true);
});
</script>

{% endblock %}
